
"""
Script de Migra√ß√£o Manual para preparar o banco para o APK
Adiciona suporte a Geolocaliza√ß√£o e Solicita√ß√µes de Torres.
FOR√áA O USO DO POSTGRESQL.
"""
import asyncio
from sqlalchemy import text
from sqlalchemy.ext.asyncio import create_async_engine

# URL Definitiva do PostgreSQL (Hardcoded para garantir Migra√ß√£o)
# Em produ√ß√£o viria de vari√°vel de ambiente, mas aqui queremos garantir que o script rode no banco certo.
DATABASE_URL = "postgresql+asyncpg://postgres:postgres@localhost/monitor"

async def update_database():
    print(f"üîÑ Conectando ao PostgreSQL em: {DATABASE_URL}")
    
    engine = create_async_engine(DATABASE_URL, echo=True)
    
    async with engine.begin() as conn:
        # 1. Atualizar Tabela TOWERS (Latitude/Longitude)
        print("üó∫Ô∏è Adicionando colunas de GEO em Towers...")
        try:
            await conn.execute(text("ALTER TABLE towers ADD COLUMN IF NOT EXISTS latitude FLOAT;"))
            await conn.execute(text("ALTER TABLE towers ADD COLUMN IF NOT EXISTS longitude FLOAT;"))
        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao alterar towers (pode j√° existir): {e}")

        # 2. Atualizar Tabela EQUIPMENTS (Clientes/Paineis)
        print("üì° Adicionando colunas de Clientes em Equipments...")
        try:
            await conn.execute(text("ALTER TABLE equipments ADD COLUMN IF NOT EXISTS is_panel BOOLEAN DEFAULT FALSE;"))
            await conn.execute(text("ALTER TABLE equipments ADD COLUMN IF NOT EXISTS associated_clients INTEGER DEFAULT 0;"))
        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao equipamentos: {e}")

        # 3. Criar Tabela TOWER_REQUESTS
        # Removido SERIAL -> GENERATED BY DEFAULT AS IDENTITY (Padr√£o SQL moderno) 
        # ou Serial funciona no Postgres, mas vamos simplificar.
        print("üìù Criando tabela de Solicita√ß√µes (Tower Requests)...")
        create_table_sql = """
        CREATE TABLE IF NOT EXISTS tower_requests (
            id SERIAL PRIMARY KEY,
            name VARCHAR,
            ip VARCHAR,
            latitude FLOAT,
            longitude FLOAT,
            requested_by VARCHAR,
            created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT (NOW() AT TIME ZONE 'utc'),
            status VARCHAR DEFAULT 'pending'
        );
        """
        try:
            await conn.execute(text(create_table_sql))
            await conn.execute(text("CREATE INDEX IF NOT EXISTS ix_tower_requests_id ON tower_requests (id);"))
        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao criar tower_requests: {e}")

    print("‚úÖ Atualiza√ß√£o do PostgreSQL conclu√≠da!")
    await engine.dispose()

if __name__ == "__main__":
    asyncio.run(update_database())
